---
title: "Analysis"
author: "Jack Alperstein"
date: "2024-02-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

This dataset is a simulated replica of my ILE/Thesis project. It is a group of 10 emergency room datasets, one for each year from 2010 to 2019. The goal of my project is to create a case-crossover study and use Principal Language Spoken as a novel socio-demographic predictor for risk of heat-related emergency room visits. Some data cleaning is done here because these CSVs are original datasets and must be manipulated before analysis can be done. 

There are 5 outcomes of note: **HEAT** for all heat illnesses (ICD-10: "992" OR ("T67", "X30")), **FEI** for fluid electrolyte imbalance (ICD-10: "276" OR ("E86", "E87")), **CKD** for chronic kidney disease (ICD-10: "585" OR "N18"), **AKI** for acute kidney injury (ICD-10:"584" OR "N17"), and **RENAL** for all renal diseases (ICD-10:"580", "581", "582", "583", "584", "585", "586", "587", "588", "589", "590", "591", "592", "593") OR ("N00", "N01", "N02", "N03", "N04", "N05", "N08", "N10", "N11", "N12", "N13", "N15", "N16", "N17", "N18", "N19", "N20", "N25", "N26", "N27", "N28", "R80")).

There is a second set of outcomes that identify primary outcomes. For example, it is possible be admitted to the emergency room for heat stroke (HEAT) and fluid electrolyte imbalance (FEI) so these second set of outcomes, labeled HEAT1, FEI1, CKD1, AKI1, and RENAL1, indicate which single outcome was designated as the primary reason for visit.

The analysis objectives are to see the demographic makeup of our patient population and what outcomes emergency rooms are receiving most often. 

# Data Set

```{r import_data, message=FALSE}
pacman::p_load(data.table, tidyverse, gtsummary)

here::i_am("code/02_analysis.Rmd")

# simple naming list of all 10 CSVs in data folder
csv_files <- list.files(path = "../data/", pattern = "\\.csv$")

# combine all identified files into a large list
csv_list <- setNames(lapply(paste0("../data/", csv_files), fread), csv_files)
```


```{r convert_data}
# convert variables for each CSV (which does not retain factor information)
convert_variables <- function(df) {
  df %>%
    mutate(PATCO = factor(case_when(
      PATCO == "Los_Angeles" ~ "Los Angeles",
      PATCO == "San_Bernardino" ~ "San Bernardino",
      TRUE ~ PATCO
      )),
      SEX = factor(SEX),
      RACE = factor(RACE),
      ETH = factor(ETH),
      PAYOR = factor(PAYOR),
      PATZIP = factor(PATZIP),
      LANG = factor(LANG),
      HEAT = factor(HEAT),
      FEI = factor(FEI),
      CKD = factor(CKD),
      AKI = factor(AKI),
      RENAL = factor(RENAL),
      HEAT1 = factor(HEAT1),
      FEI1 = factor(FEI1),
      CKD1 = factor(CKD1),
      AKI1 = factor(AKI1),
      RENAL1 = factor(RENAL1)
    )
}
```


```{r combine_data}
# apply function to each dataframe in the list
csv_list_fac_lab <- lapply(csv_list, convert_variables)

# create a single dataframe, combining each CSV in the list, add column to identify origin CSV and make it a factor
dataset <- bind_rows(csv_list_fac_lab, .id = "CSV") %>% 
  mutate(CSV = as.factor(CSV))

# remove working variables, objects, functions
rm(csv_files, csv_list, csv_list_fac_lab, convert_variables)
```


# Table 1
```{r table_one}
dataset <- dataset %>%
  mutate(ENG_SPA_OTH = as.factor(ifelse(LANG == "English", "English",
                                        ifelse(LANG == "Spanish", "Spanish", "Other")))) %>% 
  mutate(ENG_SPA_OTH = factor(ENG_SPA_OTH, levels = c("English", "Spanish", "Other")))

table1 <- tbl_summary(
  dataset,
  by = ENG_SPA_OTH,
  include = c(PATCO, SEX, AGE, RACE, ETH, PAYOR, HEAT, FEI, AKI, CKD, RENAL, HEAT1, FEI1, AKI1, CKD1, RENAL1),
  label = list(
    PATCO ~ "County",
    SEX ~ "Sex",
    AGE ~ "Age",
    RACE ~ "Race",
    ETH ~ "Ethnicity",
    PAYOR ~ "Method of Payment",
    HEAT ~ "All Heat Illnesses (HEAT)",
    FEI ~ "Fluid Electrolyte Imbalance (FEI)",
    AKI ~ "Acute Kidney Injury (AKI)",
    CKD ~ "Chronic Kidney Disease (CKD)",
    RENAL ~ "All Renal Diseases (RENAL)",
    HEAT1 ~ "HEAT is Primary Reason for Visit",
    FEI1 ~ "FEI is Primary Reason for Visit",
    AKI1 ~ "AKI is Primary Reason for Visit",
    CKD1 ~ "CKD is Primary Reason for Visit",
    RENAL1 ~ "RENAL is Primary Reason for Visit"),
  missing_text = "Missing") %>%  
  add_overall(col_label = "**Total**, N = {n}") %>% 
  bold_labels() %>% 
  modify_footnote(update = everything() ~ NA) %>% 
  modify_header(label = "**Variable**") %>% 
  as_gt() %>% gt::tab_header(title = "Table 1. Descriptive Statistics",
                 subtitle = "Baseline Demographic and Language Data, 2010 - 2019")

table1
```

# Table description
Table 1 shows quite a bit of information about our population. The number of people whose Principal Language Spoken are English, Spanish, or Other Languages are used as primary vertical columns. We can see which counties provide the most demographic information, the sex, age, race, ethnicity, payor, and outcome information. The outcomes are interesting and reflect the similar values of the actual information found in my study. 

# Figure 1
```{r figure, fig.align='center', fig.width=10, fig.height=5}
daily_visits <- dataset %>%
  pivot_longer(cols = c(HEAT1, FEI1, AKI1, CKD1, RENAL1), names_to = "Outcome", values_to = "Presence") %>%
  filter(Presence == 1) %>%
  group_by(DATE, Outcome) %>%
  summarise(Visits = n(), .groups = 'drop')

outcome_labels <- c("HEAT1" = "All Heat Illnesses",
                    "FEI1" = "Fluid Electrolyte Imbalance",
                    "AKI1" = "Acute Kidney Injury",
                    "CKD1" = "Chronic Kidney Disease",
                    "RENAL1" = "All Renal Diseases")

visits <- ggplot(data = daily_visits, aes(x = DATE, y = Visits, color = Outcome)) +
  geom_line() + 
  geom_point(size = 0.5) +
  labs(title = "Daily ER Visits",
       x = "Date",
       y = "Number of Visits",
       color = "Outcome") +
  scale_color_manual(values = scales::hue_pal()(length(outcome_labels)),
                     labels = outcome_labels,
                     name = "Primary Outcome") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal()  

visits
```

# Figure description

Figure 1 shows the number of visits seen each day across our 5 counties for each primary outcome of concern. We can see that heat related illnesses are the least likely reported as the primary outcome of concern. If people are admitted to the ER, it is ofen tied to a kidney outcome or fluid imbalances as the more pressing medical situation. Renal Diseases includes a wide range of causes and is the most likely cause for someone for come in to the ER. 